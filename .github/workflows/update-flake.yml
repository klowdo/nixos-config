name: update-flake-lock
on:
  workflow_dispatch:
  schedule:
    # Run daily at 6:00 UTC (1:00 AM EST / 2:00 AM EDT)
    - cron: "0 6 * * *"

jobs:
  update-flake-lock:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
      issues: write
      id-token: write
      actions: read
    steps:
      - uses: actions/checkout@v6

      - uses: DeterminateSystems/nix-installer-action@v21

      # Disabled: GitHub-only cache, not available locally
      # - uses: DeterminateSystems/magic-nix-cache-action@v31
      #   with:
      #     use-flakehub: false

      - uses: cachix/cachix-action@v16
        with:
          name: klowdo
          authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'

      - name: Update flake.lock
        run: nix flake update

      - name: Run check and capture output
        id: nix-check
        continue-on-error: true
        run: |
          nix flake check -L 2>&1 | tee ${RUNNER_TEMP}/check-output.txt
          echo "exit_code=$?" >> $GITHUB_OUTPUT
          {
            echo "check_output<<CHECKEOF"
            grep -E "error:|deprecated" ${RUNNER_TEMP}/check-output.txt || true
            echo "CHECKEOF"
          } >> $GITHUB_OUTPUT
          if grep -qE "error:|deprecated" ${RUNNER_TEMP}/check-output.txt; then
            echo "has_warnings=true" >> $GITHUB_OUTPUT
          else
            echo "has_warnings=false" >> $GITHUB_OUTPUT
          fi

      - name: Fix evaluation issues with Claude
        if: steps.nix-check.outputs.has_warnings == 'true' || steps.nix-check.outputs.exit_code != '0'
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          claude_args: "--max-turns 10 --allowedTools Read,Edit,Write,Bash(nix flake check:*),Bash(git add:*),Bash(git commit:*),GlobTool,GrepTool"
          prompt: |
            After a flake.lock update, 'nix flake check -L' produced these warnings/errors:

            ```
            ${{ steps.nix-check.outputs.check_output }}
            ```

            Your job is ONLY to fix the nix source files that cause these warnings/errors. Do NOT modify flake.lock or run nix flake update.

            For each fix:
            1. Edit the nix source file to fix the issue
            2. Run 'nix flake check -L' to verify
            3. Commit with conventional commit format

            Make a separate commit for each issue fixed.
            NEVER add Co-Authored-By or any attribution lines to commits.

      - name: Run final check
        run: nix flake check -L

      - name: Create Pull Request
        id: create-pr
        uses: peter-evans/create-pull-request@v8
        with:
          token: ${{ secrets.GH_PAT }}
          commit-message: "chore(flake): update flake.lock"
          title: "chore(flake): update flake.lock"
          body: |
            Automated flake.lock update.

            This PR was auto-generated by the update-flake-lock workflow.
          branch: auto-update-flake-lock
          delete-branch: true

      - name: Enable auto-merge
        if: steps.create-pr.outputs.pull-request-number
        run: gh pr merge --auto --rebase "${{ steps.create-pr.outputs.pull-request-number }}"
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}

      - name: Create issue on failure
        if: failure()
        uses: actions/github-script@v8
        with:
          script: |
            const title = 'Flake update workflow failed';
            const body = `The automated flake.lock update workflow failed.\n\n[View workflow run](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`;

            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'automated,flake-update-failure'
            });

            if (issues.data.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['automated', 'flake-update-failure']
              });
            }
